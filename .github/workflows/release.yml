name: å‘å¸ƒæ„å»º

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-binaries:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows æ„å»º
          - platform: 'windows-latest'
            args: ''
            target: 'x86_64-pc-windows-msvc'
            artifact_name: 'windows-x64'
            
          # macOS æ„å»º (Intel)
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            target: 'x86_64-apple-darwin'
            artifact_name: 'macos-intel'
            
          # macOS æ„å»º (Apple Silicon)
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            target: 'aarch64-apple-darwin'
            artifact_name: 'macos-silicon'
            
          # Linux æ„å»º
          - platform: 'ubuntu-20.04'
            args: ''
            target: 'x86_64-unknown-linux-gnu'
            artifact_name: 'linux-x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: å®‰è£… Linux ä¾èµ– (ä»… Ubuntu)
        if: matrix.platform == 'ubuntu-20.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libayatana-appindicator3-dev

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          key: ${{ matrix.target }}

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci

      - name: æ„å»ºå‰ç«¯åº”ç”¨
        run: npm run build

      - name: æ„å»º Tauri åº”ç”¨
        run: npm run tauri build ${{ matrix.args }}

      - name: æŸ¥æ‰¾æ„å»ºäº§ç‰©
        shell: bash
        run: |
          find src-tauri/target -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.app" -o -name "*.deb" -o -name "*.AppImage" | head -20

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            src-tauri/target/*/release/bundle/
            src-tauri/target/release/bundle/
          if-no-files-found: error

  create-release:
    needs: build-binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3

      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          
          # ç§»åŠ¨å’Œé‡å‘½åæ–‡ä»¶
          find . -name "*.msi" -exec cp {} release-files/ \;
          find . -name "*.exe" -exec cp {} release-files/ \;
          find . -name "*.dmg" -exec cp {} release-files/ \;
          find . -name "*.deb" -exec cp {} release-files/ \;
          find . -name "*.AppImage" -exec cp {} release-files/ \;
          
          # æ˜¾ç¤ºæ‰€æœ‰æ‰¾åˆ°çš„æ–‡ä»¶
          ls -la release-files/

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: Release ${{ github.event.inputs.version || github.ref_name }}
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            ### ğŸ“¦ ä¸‹è½½é“¾æ¥
            - **Windows**: `.msi` æˆ– `.exe` æ–‡ä»¶
            - **macOS**: `.dmg` æ–‡ä»¶ (Intel å’Œ Apple Silicon ç‰ˆæœ¬)
            - **Linux**: `.deb` æˆ– `.AppImage` æ–‡ä»¶
            
            ### ğŸ”„ æ›´æ–°å†…å®¹
            è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) äº†è§£è¯¦ç»†æ›´æ”¹ã€‚
            
            ---
            *è‡ªåŠ¨ç”Ÿæˆäº ${{ github.run_number }} æ¬¡æ„å»º*
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 