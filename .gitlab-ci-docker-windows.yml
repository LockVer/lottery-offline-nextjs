# Docker äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
# ä»…éœ€è¦ Linux Runnerï¼Œä½¿ç”¨ Docker å®¹å™¨è¿›è¡Œ Windows äº¤å‰ç¼–è¯‘

stages:
  - test
  - build
  - release

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

# ç¼“å­˜é…ç½®
cache:
  key: "$CI_COMMIT_REF_NAME"
  paths:
    - node_modules/
    - target/
    - .cargo/

# å¿«é€Ÿæµ‹è¯•
test-code:
  stage: test
  image: node:18
  script:
    - npm ci
    - npm run build
    - echo "âœ… å‰ç«¯æ„å»ºæµ‹è¯•é€šè¿‡"
  only:
    - main
    - develop
    - merge_requests

# Docker äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
build-windows-docker:
  stage: build
  image: ubuntu:20.04
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    # å®‰è£…å¿…è¦å·¥å…·
    - apt-get update
    - apt-get install -y curl build-essential pkg-config libssl-dev
    
    # å®‰è£… Docker CLI
    - curl -fsSL https://get.docker.com -o get-docker.sh
    - sh get-docker.sh
    
    # å®‰è£… Node.js
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    
    # å®‰è£… Rust å’Œ Windows ç›®æ ‡
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source ~/.cargo/env
    - rustup target add x86_64-pc-windows-gnu
    
    # å®‰è£… mingw-w64 ç”¨äº Windows äº¤å‰ç¼–è¯‘
    - apt-get install -y mingw-w64
    
    # é…ç½® Cargo äº¤å‰ç¼–è¯‘
    - mkdir -p ~/.cargo
    - |
      cat >> ~/.cargo/config.toml << EOF
      [target.x86_64-pc-windows-gnu]
      linker = "x86_64-w64-mingw32-gcc"
      ar = "x86_64-w64-mingw32-ar"
      EOF
  
  script:
    # æ„å»ºå‰ç«¯
    - echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
    - npm ci
    - npm run build
    
    # äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
    - echo "ğŸš€ å¼€å§‹ Windows äº¤å‰ç¼–è¯‘..."
    - cd src-tauri
    
    # ä½¿ç”¨ cargo ç›´æ¥ç¼–è¯‘ Windows ç›®æ ‡
    - cargo build --release --target x86_64-pc-windows-gnu
    
    # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
    - echo "ğŸ“‹ ç¼–è¯‘äº§ç‰©ï¼š"
    - ls -la target/x86_64-pc-windows-gnu/release/
    - find target/x86_64-pc-windows-gnu/release/ -name "*.exe" | head -10
    
    # åˆ›å»ºç®€å•çš„æ‰“åŒ…
    - mkdir -p ../release-windows/
    - cp target/x86_64-pc-windows-gnu/release/*.exe ../release-windows/ || true
    - echo "âœ… Windows äº¤å‰ç¼–è¯‘å®Œæˆ"
    
  artifacts:
    name: "windows-cross-compiled-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-windows/
      - src-tauri/target/x86_64-pc-windows-gnu/release/*.exe
    expire_in: 30 days
    
  only:
    - main
    - develop
    - tags
    
  tags:
    - linux    # ä»…éœ€è¦ Linux Runner

# é«˜çº§ Docker æ–¹æ¡ˆ - ä½¿ç”¨ä¸“é—¨çš„äº¤å‰ç¼–è¯‘å®¹å™¨
build-windows-advanced:
  stage: build
  image: ghcr.io/cross-rs/cross:x86_64-pc-windows-gnu
  before_script:
    # å®‰è£… Node.js
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
  script:
    # æ„å»ºå‰ç«¯
    - npm ci
    - npm run build
    
    # ä½¿ç”¨ cross è¿›è¡Œäº¤å‰ç¼–è¯‘
    - cd src-tauri
    - cargo install cross --git https://github.com/cross-rs/cross
    - cross build --release --target x86_64-pc-windows-gnu
    
    # æ•´ç†äº§ç‰©
    - mkdir -p ../release-advanced/
    - cp target/x86_64-pc-windows-gnu/release/*.exe ../release-advanced/ || true
    
  artifacts:
    name: "windows-advanced-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-advanced/
    expire_in: 30 days
    
  only:
    - tags    # ä»…åœ¨æ ‡ç­¾æ—¶ä½¿ç”¨é«˜çº§æ–¹æ¡ˆ
    
  tags:
    - linux
    
  when: manual  # æ‰‹åŠ¨è§¦å‘

# ç®€å•æ–¹æ¡ˆ - åŸºç¡€äº¤å‰ç¼–è¯‘
build-windows-simple:
  stage: build
  image: rust:1.70
  before_script:
    # å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·
    - apt-get update
    - apt-get install -y mingw-w64 nodejs npm
    - rustup target add x86_64-pc-windows-gnu
    
    # é…ç½®äº¤å‰ç¼–è¯‘
    - mkdir -p ~/.cargo
    - echo '[target.x86_64-pc-windows-gnu]' >> ~/.cargo/config.toml
    - echo 'linker = "x86_64-w64-mingw32-gcc"' >> ~/.cargo/config.toml
    
  script:
    # æ„å»ºé¡¹ç›®
    - npm ci
    - npm run build
    
    # ä»…ç¼–è¯‘ Rust éƒ¨åˆ† (ä¸ä½¿ç”¨ Tauri bundle)
    - cd src-tauri
    - cargo build --release --target x86_64-pc-windows-gnu
    
    # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
    - mkdir -p ../release-simple/
    - cp target/x86_64-pc-windows-gnu/release/*.exe ../release-simple/
    - echo "âœ… ç®€å• Windows ç¼–è¯‘å®Œæˆ"
    
  artifacts:
    name: "windows-simple-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-simple/
    expire_in: 7 days
    
  only:
    - develop    # å¼€å‘åˆ†æ”¯ä½¿ç”¨ç®€å•æ–¹æ¡ˆæµ‹è¯•
    
  tags:
    - linux

# åˆ›å»ºå‘å¸ƒ
create-release:
  stage: release
  image: alpine:latest
  dependencies:
    - build-windows-docker
  before_script:
    - apk add --no-cache curl jq
  script:
    - mkdir -p final-release/
    - cp -r release-windows/* final-release/ || true
    - ls -la final-release/
    
    # åˆ›å»º Release (å¦‚æœæ˜¯æ ‡ç­¾)
    - |
      if [ "$CI_COMMIT_TAG" ]; then
        echo "ğŸš€ åˆ›å»º Release: $CI_COMMIT_TAG"
        curl --fail --request POST \
          --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
          --header "Content-Type: application/json" \
          --data '{
            "name": "Windows äº¤å‰ç¼–è¯‘ç‰ˆæœ¬ '$CI_COMMIT_TAG'",
            "tag_name": "'$CI_COMMIT_TAG'",
            "description": "ğŸ‰ ä½¿ç”¨ Docker äº¤å‰ç¼–è¯‘çš„ Windows ç‰ˆæœ¬\n\n### ğŸ“¦ åŒ…å«æ–‡ä»¶\n- Windows å¯æ‰§è¡Œæ–‡ä»¶ (.exe)\n\n### âš ï¸ æ³¨æ„äº‹é¡¹\n- æ­¤ç‰ˆæœ¬ä½¿ç”¨äº¤å‰ç¼–è¯‘ç”Ÿæˆ\n- å¦‚é‡åˆ°å…¼å®¹æ€§é—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨ç‰©ç† Windows æœºå™¨ç¼–è¯‘çš„ç‰ˆæœ¬\n\n### ğŸ”§ ç¼–è¯‘ä¿¡æ¯\n- ç¼–è¯‘æ–¹å¼: Docker äº¤å‰ç¼–è¯‘\n- ç›®æ ‡å¹³å°: x86_64-pc-windows-gnu\n- æ„å»ºæ—¶é—´: '$CI_PIPELINE_CREATED_AT'\n\n---\n*ç”± GitLab CI/CD è‡ªåŠ¨æ„å»º*"
          }' \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
      fi
      
  artifacts:
    name: "windows-final-$CI_COMMIT_TAG"
    paths:
      - final-release/
    expire_in: 90 days
    
  only:
    - tags
    
  tags:
    - linux 