# ä¸“ç”¨ Windows æ„å»ºé…ç½®
# é€‚ç”¨äºè‡ªæ­å»º GitLabï¼Œä»…æ„å»º Windows ç‰ˆæœ¬

stages:
  - test       # æµ‹è¯•é˜¶æ®µ (Linux)
  - build      # Windows æ„å»ºé˜¶æ®µ
  - release    # å‘å¸ƒé˜¶æ®µ

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

# ç¼“å­˜é…ç½® - åŠ é€Ÿæ„å»º
cache:
  key: "$CI_COMMIT_REF_NAME"
  paths:
    - node_modules/
    - target/
    - .cargo/

# å¿«é€Ÿæµ‹è¯• - ä½¿ç”¨ Linux Runner éªŒè¯ä»£ç 
test-code:
  stage: test
  image: ubuntu:20.04
  before_script:
    # å®‰è£…åŸºç¡€å·¥å…·
    - apt-get update && apt-get install -y curl build-essential
    # å®‰è£… Node.js
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
  script:
    # å®‰è£…ä¾èµ–å¹¶æ„å»ºå‰ç«¯
    - npm ci
    - npm run build
    - echo "âœ… å‰ç«¯æ„å»ºæµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œ Windows æ„å»º"
  only:
    - main
    - develop
    - merge_requests
  tags:
    - linux    # ä½¿ç”¨ Linux Runner

# Windows æ„å»º - ä¸»è¦æ„å»ºä»»åŠ¡
build-windows:
  stage: build
  before_script:
    # è®¾ç½® PowerShell æ‰§è¡Œç­–ç•¥
    - Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
    
    # æ£€æŸ¥å¹¶å®‰è£… Node.js
    - |
      if (-not (Get-Command node -ErrorAction SilentlyContinue)) {
        Write-Host "å®‰è£… Node.js..."
        # ä¸‹è½½å¹¶å®‰è£… Node.js
        $nodeUrl = "https://nodejs.org/dist/v18.17.0/node-v18.17.0-x64.msi"
        $nodeInstaller = "$env:TEMP\nodejs.msi"
        Invoke-WebRequest -Uri $nodeUrl -OutFile $nodeInstaller
        Start-Process msiexec.exe -ArgumentList "/i", $nodeInstaller, "/quiet", "/norestart" -Wait
        # æ›´æ–°ç¯å¢ƒå˜é‡
        $env:PATH = "$env:PROGRAMFILES\nodejs;$env:PATH"
      } else {
        Write-Host "âœ… Node.js å·²å®‰è£…: $(node --version)"
      }
    
    # æ£€æŸ¥å¹¶å®‰è£… Rust
    - |
      if (-not (Get-Command rustc -ErrorAction SilentlyContinue)) {
        Write-Host "å®‰è£… Rust..."
        # ä¸‹è½½å¹¶å®‰è£… Rust
        $rustUrl = "https://win.rustup.rs/x86_64"
        $rustInstaller = "$env:TEMP\rustup-init.exe"
        Invoke-WebRequest -Uri $rustUrl -OutFile $rustInstaller
        & $rustInstaller -y --default-toolchain stable
        # æ›´æ–°ç¯å¢ƒå˜é‡
        $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
      } else {
        Write-Host "âœ… Rust å·²å®‰è£…: $(rustc --version)"
      }
    
    # æ£€æŸ¥å·¥å…·ç‰ˆæœ¬
    - Write-Host "æ„å»ºç¯å¢ƒä¿¡æ¯:"
    - Write-Host "Node.js: $(node --version)"
    - Write-Host "npm: $(npm --version)"
    - Write-Host "Rust: $(rustc --version)"
    
  script:
    # å®‰è£…é¡¹ç›®ä¾èµ–
    - Write-Host "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
    - npm ci
    
    # æ„å»ºå‰ç«¯
    - Write-Host "ğŸ”¨ æ„å»ºå‰ç«¯..."
    - npm run build
    
    # æ„å»º Windows ç‰ˆæœ¬
    - Write-Host "ğŸš€ å¼€å§‹æ„å»º Windows ç‰ˆæœ¬..."
    - npm run tauri build
    
    # æŸ¥æ‰¾ç”Ÿæˆçš„æ–‡ä»¶
    - Write-Host "ğŸ“‹ æ„å»ºäº§ç‰©ï¼š"
    - Get-ChildItem -Path "src-tauri\target\release\bundle" -Recurse -Include "*.msi", "*.exe" | ForEach-Object { Write-Host "   - $($_.FullName)" }
    
  # ä¿å­˜æ„å»ºäº§ç‰©
  artifacts:
    name: "windows-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/msi/
      - src-tauri/target/release/bundle/nsis/
    expire_in: 30 days  # ä¿ç•™ 30 å¤©
    
  # è§¦å‘æ¡ä»¶
  only:
    - main      # ä¸»åˆ†æ”¯
    - develop   # å¼€å‘åˆ†æ”¯
    - tags      # ç‰ˆæœ¬æ ‡ç­¾
    
  # æŒ‡å®šä½¿ç”¨ Windows Runner
  tags:
    - windows

# åˆ›å»ºå‘å¸ƒç‰ˆæœ¬ (ä»…æ ‡ç­¾è§¦å‘)
create-release:
  stage: release
  image: alpine:latest
  dependencies:
    - build-windows
  before_script:
    - apk add --no-cache curl jq
  script:
    # åˆ›å»ºå‘å¸ƒæ–‡ä»¶å¤¹
    - mkdir -p release-files
    
    # æ”¶é›† Windows æ„å»ºäº§ç‰©
    - find . -name "*.msi" -exec cp {} release-files/ \; || true
    - find . -name "*.exe" -exec cp {} release-files/ \; || true
    
    # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
    - echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶ï¼š"
    - ls -la release-files/
    
    # åˆ›å»º GitLab Release (ä»…å½“æœ‰æ ‡ç­¾æ—¶)
    - |
      if [ "$CI_COMMIT_TAG" ]; then
        echo "ğŸš€ åˆ›å»º GitLab Release: $CI_COMMIT_TAG"
        
        # ä½¿ç”¨ GitLab API åˆ›å»º Release
        curl --fail --request POST \
          --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
          --header "Content-Type: application/json" \
          --data '{
            "name": "Windows ç‰ˆæœ¬ '$CI_COMMIT_TAG'",
            "tag_name": "'$CI_COMMIT_TAG'",
            "description": "ğŸ‰ Windows è‡ªåŠ¨æ„å»ºç‰ˆæœ¬\n\n### ğŸ“¦ åŒ…å«æ–‡ä»¶\n- Windows å®‰è£…åŒ… (.msi)\n- Windows å¯æ‰§è¡Œæ–‡ä»¶ (.exe)\n\n### ğŸ”§ æ„å»ºä¿¡æ¯\n- æ„å»ºæ—¶é—´: '$CI_PIPELINE_CREATED_AT'\n- æäº¤ç‰ˆæœ¬: '$CI_COMMIT_SHORT_SHA'\n- åˆ†æ”¯: '$CI_COMMIT_REF_NAME'\n\n### ğŸ“¥ ä¸‹è½½è¯´æ˜\n1. ä¸‹è½½ .msi æ–‡ä»¶è¿›è¡Œæ ‡å‡†å®‰è£…\n2. æˆ–ä¸‹è½½ .exe æ–‡ä»¶ç›´æ¥è¿è¡Œ\n\n---\n*ç”± GitLab CI/CD è‡ªåŠ¨æ„å»º*"
          }' \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
      else
        echo "â„¹ï¸  éæ ‡ç­¾æäº¤ï¼Œè·³è¿‡ Release åˆ›å»º"
      fi
    
  artifacts:
    name: "windows-release-$CI_COMMIT_TAG"
    paths:
      - release-files/
    expire_in: 90 days
    
  only:
    - tags  # ä»…åœ¨æ¨é€æ ‡ç­¾æ—¶åˆ›å»ºå‘å¸ƒ
    
  tags:
    - linux  # å‘å¸ƒä»»åŠ¡ä½¿ç”¨ Linux Runner

# æ‰‹åŠ¨æµ‹è¯•æ„å»º - ç”¨äºè°ƒè¯•
manual-test:
  stage: build
  before_script:
    - Write-Host "ğŸ” æ‰‹åŠ¨æµ‹è¯•æ„å»ºå¼€å§‹..."
    - Write-Host "Node.js: $(node --version)"
    - Write-Host "Rust: $(rustc --version)"
  script:
    - npm ci
    - npm run build
    - Write-Host "âœ… æ‰‹åŠ¨æµ‹è¯•å®Œæˆï¼"
  artifacts:
    name: "manual-test-$CI_COMMIT_SHORT_SHA"
    paths:
      - dist/
    expire_in: 3 days
  when: manual  # ä»…æ‰‹åŠ¨è§¦å‘
  tags:
    - windows 