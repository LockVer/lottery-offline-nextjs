# GitLab CI/CD é…ç½® - Windows åŸç”Ÿç¼–è¯‘
# é€‚ç”¨äºå…¨æ–°çš„ Windows ç³»ç»Ÿï¼Œè‡ªåŠ¨å®‰è£…æ‰€æœ‰å¿…è¦å·¥å…·

stages:
  - build

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  # PowerShell æ‰§è¡Œç­–ç•¥
  POWERSHELL_TELEMETRY_OPTOUT: 1
  # è·³è¿‡è‡ªåŠ¨ Git å…‹éš†ï¼ˆå› ä¸º Git å¯èƒ½æœªå®‰è£…ï¼‰
  GIT_STRATEGY: none

# ç¼“å­˜é…ç½®
cache:
  key: "$CI_COMMIT_REF_NAME"
  paths:
    - node_modules/
    - .cargo/
    - C:\tools\

# Windows åŸç”Ÿç¼–è¯‘ - å…¨æ–°ç³»ç»Ÿè‡ªåŠ¨é…ç½®
build-windows-native:
  stage: build
  before_script:
    # è®¾ç½® PowerShell æ‰§è¡Œç­–ç•¥
    - Set-ExecutionPolicy Bypass -Scope Process -Force
    - echo "ğŸš€ å¼€å§‹é…ç½®å…¨æ–° Windows ç¼–è¯‘ç¯å¢ƒ..."
    
    # æ£€æŸ¥å¹¶å®‰è£… Chocolatey åŒ…ç®¡ç†å™¨
    - echo "ğŸ“¦ å®‰è£… Chocolatey åŒ…ç®¡ç†å™¨..."
    - |
      if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
        Write-Host "å®‰è£… Chocolatey..."
        try {
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          refreshenv
          Write-Host "âœ… Chocolatey å®‰è£…å®Œæˆ"
        } catch {
          Write-Host "âŒ Chocolatey å®‰è£…å¤±è´¥: $($_.Exception.Message)"
          Write-Host "å°è¯•å¤‡ç”¨å®‰è£…æ–¹æ³•..."
          # å¤‡ç”¨æ–¹æ³•ï¼šä¸‹è½½åˆ°æœ¬åœ°å†æ‰§è¡Œ
          $chocoScript = "$env:TEMP\install-chocolatey.ps1"
          Invoke-WebRequest -Uri 'https://community.chocolatey.org/install.ps1' -OutFile $chocoScript -UseBasicParsing
          & $chocoScript
          Remove-Item $chocoScript
        }
      } else {
        Write-Host "âœ… Chocolatey å·²å®‰è£…"
      }
    
    # å®‰è£… Gitï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
    - echo "ğŸ”§ æ£€æŸ¥å¹¶å®‰è£… Git..."
    - |
      if (!(Get-Command git -ErrorAction SilentlyContinue)) {
        Write-Host "å®‰è£… Git..."
        try {
          choco install git -y --no-progress
          refreshenv
          # æ‰‹åŠ¨æ·»åŠ  Git åˆ° PATH
          $env:PATH += ";C:\Program Files\Git\bin;C:\Program Files\Git\cmd"
          Write-Host "âœ… Git å®‰è£…å®Œæˆ"
        } catch {
          Write-Host "âŒ Git å®‰è£…å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸‹è½½..."
          # å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥ä¸‹è½½ Git ä¾¿æºç‰ˆ
          $gitUrl = "https://github.com/git-for-windows/git/releases/download/v2.47.1.windows.1/PortableGit-2.47.1-64-bit.7z.exe"
          $gitPath = "$env:TEMP\git-portable.exe"
          $gitDir = "C:\tools\git"
          
          Invoke-WebRequest -Uri $gitUrl -OutFile $gitPath -UseBasicParsing
          New-Item -ItemType Directory -Path $gitDir -Force
          Start-Process -FilePath $gitPath -ArgumentList "-o$gitDir", "-y" -Wait -NoNewWindow
          Remove-Item $gitPath
          
          $env:PATH += ";$gitDir\bin;$gitDir\cmd"
        }
      } else {
        Write-Host "âœ… Git å·²å®‰è£…: $(git --version)"
      }
    
    # æ‰‹åŠ¨å…‹éš†ä»£ç ä»“åº“ï¼ˆå› ä¸ºæˆ‘ä»¬è·³è¿‡äº†è‡ªåŠ¨å…‹éš†ï¼‰
    - echo "ğŸ“ æ‰‹åŠ¨å…‹éš†ä»£ç ä»“åº“..."
    - |
      $projectPath = $PWD.Path
      Write-Host "å½“å‰å·¥ä½œç›®å½•: $projectPath"
      
      # æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»£ç 
      if (Test-Path ".git") {
        Write-Host "âœ… ä»£ç ä»“åº“å·²å­˜åœ¨"
      } else {
        Write-Host "å…‹éš†ä»£ç ä»“åº“..."
        try {
          git clone $env:CI_REPOSITORY_URL .
          git checkout $env:CI_COMMIT_SHA
          Write-Host "âœ… ä»£ç å…‹éš†å®Œæˆ"
        } catch {
          Write-Host "âŒ Git å…‹éš†å¤±è´¥: $($_.Exception.Message)"
          Write-Host "å°è¯•ä½¿ç”¨ HTTP æ–¹å¼..."
          $httpUrl = $env:CI_REPOSITORY_URL -replace 'git@([^:]+):', 'https://$1/'
          git clone $httpUrl .
          git checkout $env:CI_COMMIT_SHA
        }
      }
    
    # å®‰è£… Node.js 22.16.0
    - echo "ğŸ“¦ å®‰è£… Node.js 22.16.0..."
    - |
      if (!(Get-Command node -ErrorAction SilentlyContinue)) {
        Write-Host "å®‰è£… Node.js 22.16.0..."
        try {
          choco install nodejs --version=22.16.0 -y --force --no-progress
          refreshenv
          # æ‰‹åŠ¨æ·»åŠ åˆ° PATHï¼ˆé˜²æ­¢ç¯å¢ƒå˜é‡é—®é¢˜ï¼‰
          $env:PATH += ";C:\Program Files\nodejs"
          Write-Host "âœ… Node.js å®‰è£…å®Œæˆ"
        } catch {
          Write-Host "âŒ Node.js å®‰è£…å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸‹è½½..."
          # å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥ä¸‹è½½ Node.js
          $nodeUrl = "https://nodejs.org/dist/v22.16.0/node-v22.16.0-win-x64.zip"
          $nodePath = "$env:TEMP\node.zip"
          $nodeDir = "C:\tools\nodejs"
          
          Invoke-WebRequest -Uri $nodeUrl -OutFile $nodePath -UseBasicParsing
          Expand-Archive $nodePath $nodeDir -Force
          Remove-Item $nodePath
          
          $env:PATH += ";$nodeDir\node-v22.16.0-win-x64"
        }
      } else {
        $nodeVersion = node --version
        Write-Host "âœ… Node.js å·²å®‰è£…: $nodeVersion"
        if ($nodeVersion -notlike "v22.16.*") {
          Write-Host "å‡çº§åˆ° Node.js 22.16.0..."
          choco upgrade nodejs --version=22.16.0 -y --force --no-progress
          refreshenv
        }
      }
    
    # å®‰è£… Rust
    - echo "ğŸ¦€ å®‰è£… Rust..."
    - |
      if (!(Get-Command cargo -ErrorAction SilentlyContinue)) {
        Write-Host "å®‰è£… Rust..."
        try {
          # ä¸‹è½½ Rust å®‰è£…å™¨
          $rustupUrl = "https://win.rustup.rs/x86_64"
          $rustupPath = "$env:TEMP\rustup-init.exe"
          Invoke-WebRequest -Uri $rustupUrl -OutFile $rustupPath -UseBasicParsing
          
          # é™é»˜å®‰è£… Rust
          Start-Process -FilePath $rustupPath -ArgumentList "-y", "--default-toolchain", "stable" -Wait -NoNewWindow
          Remove-Item $rustupPath
          
          # æ‰‹åŠ¨æ·»åŠ  Cargo åˆ° PATH
          $env:PATH += ";$env:USERPROFILE\.cargo\bin"
          
          # åˆ·æ–°ç¯å¢ƒå˜é‡
          $env:CARGO_HOME = "$env:USERPROFILE\.cargo"
          $env:RUSTUP_HOME = "$env:USERPROFILE\.rustup"
          Write-Host "âœ… Rust å®‰è£…å®Œæˆ"
        } catch {
          Write-Host "âŒ Rust å®‰è£…å¤±è´¥: $($_.Exception.Message)"
          exit 1
        }
      } else {
        Write-Host "âœ… Rust å·²å®‰è£…: $(cargo --version)"
      }
    
    # å®‰è£… Visual Studio Build Toolsï¼ˆæ”¹ä¸ºç¦»çº¿å®‰è£…æ–¹å¼ï¼‰
    - echo "ğŸ”§ å®‰è£… Visual Studio Build Tools..."
    - |
      if (!(Get-Command cl -ErrorAction SilentlyContinue)) {
        Write-Host "å®‰è£… Visual Studio Build Tools 2022..."
        try {
          # æ–¹æ³•1ï¼šä½¿ç”¨ Chocolatey
          Write-Host "å°è¯•ä½¿ç”¨ Chocolatey å®‰è£…..."
          choco install visualstudio2022buildtools -y --no-progress --timeout=3600
          choco install visualstudio2022-workload-vctools -y --no-progress --timeout=3600
          refreshenv
          Write-Host "âœ… Visual Studio Build Tools å®‰è£…å®Œæˆ"
        } catch {
          Write-Host "âŒ Chocolatey å®‰è£…å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸‹è½½å®‰è£…å™¨..."
          # æ–¹æ³•2ï¼šç›´æ¥ä¸‹è½½å®˜æ–¹å®‰è£…å™¨
          $vsUrl = "https://aka.ms/vs/17/release/vs_buildtools.exe"
          $vsPath = "$env:TEMP\vs_buildtools.exe"
          
          Write-Host "ä¸‹è½½ Visual Studio Build Tools å®‰è£…å™¨..."
          Invoke-WebRequest -Uri $vsUrl -OutFile $vsPath -UseBasicParsing
          
          Write-Host "å®‰è£… Visual Studio Build Toolsï¼ˆç¦»çº¿æ¨¡å¼ï¼‰..."
          $arguments = @(
            "--quiet"
            "--wait"
            "--add", "Microsoft.VisualStudio.Workload.VCTools"
            "--add", "Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
            "--add", "Microsoft.VisualStudio.Component.Windows11SDK.22621"
            "--includeRecommended"
            "--nocache"
          )
          Start-Process -FilePath $vsPath -ArgumentList $arguments -Wait -NoNewWindow
          Remove-Item $vsPath
          
          # æ·»åŠ  MSVC åˆ°ç¯å¢ƒå˜é‡
          $vctools = Get-ChildItem "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Tools\MSVC\" | Sort-Object Name -Descending | Select-Object -First 1
          if ($vctools) {
            $env:PATH += ";$($vctools.FullName)\bin\Hostx64\x64"
          }
        }
      } else {
        Write-Host "âœ… Visual Studio Build Tools å·²å®‰è£…"
      }
    
    # éªŒè¯æ‰€æœ‰å·¥å…·å®‰è£…
    - echo "ğŸ” éªŒè¯å¼€å‘ç¯å¢ƒ..."
    - |
      Write-Host "=== ç¯å¢ƒæ£€æŸ¥ ==="
      $allGood = $true
      
      try {
        $nodeVer = node --version
        Write-Host "âœ… Node.js: $nodeVer"
      } catch {
        Write-Host "âŒ Node.js æœªæ­£ç¡®å®‰è£…"
        $allGood = $false
      }
      
      try {
        $npmVer = npm --version
        Write-Host "âœ… npm: $npmVer"
      } catch {
        Write-Host "âŒ npm æœªæ­£ç¡®å®‰è£…"
        $allGood = $false
      }
      
      try {
        $cargoVer = cargo --version
        Write-Host "âœ… Cargo: $cargoVer"
      } catch {
        Write-Host "âŒ Rust/Cargo æœªæ­£ç¡®å®‰è£…"
        $allGood = $false
      }
      
      try {
        $rustcVer = rustc --version
        Write-Host "âœ… Rustc: $rustcVer"
      } catch {
        Write-Host "âŒ Rustc æœªæ­£ç¡®å®‰è£…"
        $allGood = $false
      }
      
      if ($allGood) {
        Write-Host "ğŸ‰ æ‰€æœ‰å·¥å…·å®‰è£…å®Œæˆï¼"
      } else {
        Write-Host "âŒ éƒ¨åˆ†å·¥å…·å®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•æ„å»º..."
      }
    
  script:
    # è®¾ç½® npm é•œåƒæºï¼ˆæé«˜ä¸‹è½½é€Ÿåº¦ï¼‰
    - echo "âš™ï¸ é…ç½® npm é•œåƒæº..."
    - npm config set registry https://registry.npmmirror.com
    
    # å®‰è£…é¡¹ç›®ä¾èµ–
    - echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
    - npm ci
    
    # æ„å»ºå‰ç«¯
    - echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
    - npm run build
    
    # ç¼–è¯‘ Tauri åº”ç”¨
    - echo "ğŸš€ å¼€å§‹ç¼–è¯‘ Tauri åº”ç”¨..."
    - cd src-tauri
    
    # ç¡®ä¿ Rust ç¯å¢ƒå˜é‡æ­£ç¡®
    - $env:CARGO_HOME = "$env:USERPROFILE\.cargo"
    - $env:RUSTUP_HOME = "$env:USERPROFILE\.rustup"
    - $env:PATH += ";$env:USERPROFILE\.cargo\bin"
    
    # ç¼–è¯‘ Release ç‰ˆæœ¬
    - cargo build --release
    
    # æ£€æŸ¥ç¼–è¯‘äº§ç‰©
    - echo "ğŸ“‹ æ£€æŸ¥ç¼–è¯‘äº§ç‰©..."
    - |
      $exeFiles = Get-ChildItem -Path "target\release\" -Filter "*.exe" -File
      if ($exeFiles.Count -gt 0) {
        Write-Host "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶:"
        foreach ($file in $exeFiles) {
          Write-Host "  - $($file.Name) ($([math]::Round($file.Length/1MB, 2)) MB)"
        }
      } else {
        Write-Host "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
        Get-ChildItem -Path "target\release\" -File | Format-Table Name, Length
      }
    
    # æ•´ç†å‘å¸ƒæ–‡ä»¶
    - echo "ğŸ“¦ æ•´ç†å‘å¸ƒæ–‡ä»¶..."
    - cd ..
    - New-Item -ItemType Directory -Path "release-windows" -Force
    - |
      $sourceFiles = Get-ChildItem -Path "src-tauri\target\release\" -Filter "*.exe" -File
      if ($sourceFiles.Count -gt 0) {
        foreach ($file in $sourceFiles) {
          Copy-Item $file.FullName -Destination "release-windows\" -Force
          Write-Host "âœ… å¤åˆ¶: $($file.Name)"
        }
      } else {
        Write-Host "âŒ æ²¡æœ‰æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œå¤åˆ¶"
      }
    
    # æ˜¾ç¤ºæœ€ç»ˆç»“æœ
    - echo "ğŸ“‹ æœ€ç»ˆå‘å¸ƒæ–‡ä»¶:"
    - Get-ChildItem -Path "release-windows" -File | Format-Table Name, Length, LastWriteTime
    - echo "ğŸ‰ Windows åŸç”Ÿç¼–è¯‘å®Œæˆï¼"
    
  artifacts:
    name: "windows-native-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-windows/
    expire_in: 30 days
    when: always
    reports:
      # ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
      junit: []
    
  only:
    - main
    - develop
    - merge_requests
    - tags
    
  tags:
    - windows  # ç¡®ä¿ä½¿ç”¨ Windows Runner
    
  # è¶…æ—¶è®¾ç½®ï¼ˆå…¨æ–°ç³»ç»Ÿé¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰
  timeout: 2h
  
  # å…è®¸å¤±è´¥ï¼Œæ–¹ä¾¿è°ƒè¯•
  allow_failure: true

# å¿«é€Ÿæµ‹è¯•ä½œä¸šï¼ˆé€‚ç”¨äºå·²å®‰è£…å¼€å‘ç¯å¢ƒçš„ Runnerï¼‰
build-windows-quick:
  stage: build
  variables:
    # è¿™ä¸ªä½œä¸šå‡è®¾ç¯å¢ƒå·²é…ç½®ï¼Œå¯ä»¥æ­£å¸¸å…‹éš†ä»£ç 
    GIT_STRATEGY: fetch
  
  before_script:
    - echo "ğŸ” å¿«é€Ÿç¯å¢ƒæ£€æŸ¥..."
    - node --version
    - npm --version
    - cargo --version
    
  script:
    - echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
    - npm ci
    
    - echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
    - npm run build
    
    - echo "ğŸš€ ç¼–è¯‘åº”ç”¨..."
    - cd src-tauri
    - cargo build --release
    
    - echo "ğŸ“¦ æ•´ç†æ–‡ä»¶..."
    - cd ..
    - New-Item -ItemType Directory -Path "release-quick" -Force
    - Copy-Item "src-tauri\target\release\*.exe" "release-quick\" -ErrorAction SilentlyContinue
    - Get-ChildItem "release-quick"
    
  artifacts:
    name: "windows-quick-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-quick/
    expire_in: 7 days
    
  only:
    - develop  # ä»…åœ¨å¼€å‘åˆ†æ”¯ä½¿ç”¨å¿«é€Ÿæ¨¡å¼
    
  tags:
    - windows
    
  when: manual  # æ‰‹åŠ¨è§¦å‘

 