# Docker äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
# ä»…éœ€è¦ Linux Runnerï¼Œä½¿ç”¨ Docker å®¹å™¨è¿›è¡Œ Windows äº¤å‰ç¼–è¯‘

stages:
  - build

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  DEBIAN_FRONTEND: noninteractive

# ç¼“å­˜é…ç½®
cache:
  key: "$CI_COMMIT_REF_NAME"
  paths:
    - node_modules/
    - target/
    - .cargo/

# ç½‘ç»œä¼˜åŒ–ç‰ˆæœ¬ - å”¯ä¸€çš„æ„å»ºä½œä¸š
build-windows-optimized:
  stage: build
  image: ubuntu:22.04
  variables:
    # ä½¿ç”¨æ¸…åå¤§å­¦é•œåƒæºè§£å†³ç½‘ç»œé—®é¢˜
    MIRROR_URL: "https://mirrors.tuna.tsinghua.edu.cn"
  before_script:
    # é…ç½® APT é•œåƒæº
    - |
      cat > /etc/apt/sources.list << EOF
      deb ${MIRROR_URL}/ubuntu/ jammy main restricted universe multiverse
      deb ${MIRROR_URL}/ubuntu/ jammy-updates main restricted universe multiverse  
      deb ${MIRROR_URL}/ubuntu/ jammy-backports main restricted universe multiverse
      deb ${MIRROR_URL}/ubuntu/ jammy-security main restricted universe multiverse
      EOF
    
    # æ›´æ–°åŒ…åˆ—è¡¨
    - apt-get update || echo "ğŸ“ æ›´æ–°å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
    
    # å®‰è£…åŸºç¡€å·¥å…·
    - apt-get install -y wget curl ca-certificates gnupg lsb-release build-essential pkg-config libssl-dev xz-utils || true
    
    # æ›´æ–° CA è¯ä¹¦
    - update-ca-certificates || true
    
    # å®‰è£… Node.js 22.16.0 (ä½¿ç”¨å¤šä¸ªé•œåƒæºå¤‡é€‰)
    - echo "ğŸ“¦ å®‰è£… Node.js 22.16.0..."
    - |
      # å°è¯•å¤šä¸ªä¸‹è½½æº
      NODE_URL=""
      for url in \
        "https://nodejs.org/dist/v22.16.0/node-v22.16.0-linux-x64.tar.xz" \
        "https://mirrors.tuna.tsinghua.edu.cn/nodejs-release/v22.16.0/node-v22.16.0-linux-x64.tar.xz" \
        "https://npm.taobao.org/mirrors/node/v22.16.0/node-v22.16.0-linux-x64.tar.xz"
      do
        echo "å°è¯•ä¸‹è½½: $url"
        if wget -T 30 -t 3 -qO /tmp/node.tar.xz "$url"; then
          NODE_URL="$url"
          echo "âœ… æˆåŠŸä¸‹è½½: $url"
          break
        else
          echo "âŒ ä¸‹è½½å¤±è´¥: $url"
        fi
      done
      
      # å¦‚æœéƒ½å¤±è´¥äº†ï¼Œå°è¯•ç”¨ curl
      if [ ! -f /tmp/node.tar.xz ]; then
        echo "wget å…¨éƒ¨å¤±è´¥ï¼Œå°è¯• curl..."
        curl -fsSL -o /tmp/node.tar.xz https://nodejs.org/dist/v22.16.0/node-v22.16.0-linux-x64.tar.xz || echo "curl ä¹Ÿå¤±è´¥äº†"
      fi
    
    # è§£å‹å’Œå®‰è£… Node.js
    - |
      if [ -f /tmp/node.tar.xz ]; then
        echo "ğŸ“‚ è§£å‹ Node.js..."
        tar -xJ -C /opt -f /tmp/node.tar.xz
        ln -sf /opt/node-v22.16.0-linux-x64/bin/* /usr/local/bin/
        echo "ğŸ‰ Node.js å®‰è£…å®Œæˆ"
      else
        echo "âŒ Node.js ä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨..."
        apt-get install -y nodejs npm || echo "ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…ä¹Ÿå¤±è´¥"
      fi
    
    # éªŒè¯ Node.js å®‰è£…
    - echo "ğŸ” éªŒè¯ Node.js å®‰è£…..."
    - node --version || echo "âŒ Node.js ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
    - npm --version || echo "âŒ npm ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
    
    # å®‰è£… mingw-w64 ç”¨äº Windows äº¤å‰ç¼–è¯‘
    - echo "ğŸ”§ å®‰è£… Windows äº¤å‰ç¼–è¯‘å·¥å…·..."
    - apt-get install -y mingw-w64 || echo "âŒ mingw-w64 å®‰è£…å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
    
    # å®‰è£… Rust (ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬)
    - echo "ğŸ¦€ å®‰è£… Rust..."
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
    - source ~/.cargo/env
    - rustup target add x86_64-pc-windows-gnu || echo "âŒ æ·»åŠ  Windows ç›®æ ‡å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
    
    # é…ç½® Cargo äº¤å‰ç¼–è¯‘
    - echo "âš™ï¸ é…ç½® Cargo äº¤å‰ç¼–è¯‘..."
    - mkdir -p ~/.cargo
    - |
      cat >> ~/.cargo/config.toml << EOF
      [target.x86_64-pc-windows-gnu]
      linker = "x86_64-w64-mingw32-gcc"
      ar = "x86_64-w64-mingw32-ar"
      EOF
      
  script:
    # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
    - echo "ğŸ” ç¯å¢ƒä¿¡æ¯æ£€æŸ¥ï¼š"
    - echo "Node.js: $(node --version || echo 'æœªå®‰è£…')"
    - echo "npm: $(npm --version || echo 'æœªå®‰è£…')"
    - echo "Rust: $(rustc --version || echo 'æœªå®‰è£…')"
    - echo "Cargo: $(cargo --version || echo 'æœªå®‰è£…')"
    
    # å®‰è£…ä¾èµ–
    - echo "ğŸ“¦ å®‰è£… Node.js ä¾èµ–..."
    - npm config set registry https://registry.npmmirror.com || echo "è®¾ç½®é•œåƒæºå¤±è´¥"
    - npm ci || npm install || echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
    
    # æ„å»ºå‰ç«¯
    - echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
    - npm run build || echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
    
    # ç¼–è¯‘ Rust éƒ¨åˆ†
    - echo "ğŸš€ å¼€å§‹ Windows äº¤å‰ç¼–è¯‘..."
    - cd src-tauri
    - source ~/.cargo/env || echo "âŒ Cargo ç¯å¢ƒåŠ è½½å¤±è´¥"
    
    # æ£€æŸ¥ Rust ç¯å¢ƒ
    - echo "ğŸ”§ æ£€æŸ¥ Rust ç¯å¢ƒ..."
    - rustc --version || echo "âŒ Rust ç¯å¢ƒæœ‰é—®é¢˜"
    - cargo --version || echo "âŒ Cargo ç¯å¢ƒæœ‰é—®é¢˜"
    - rustup target list --installed | grep windows || echo "âŒ Windows ç›®æ ‡æœªå®‰è£…"
    
    # å°è¯• Windows äº¤å‰ç¼–è¯‘
    - echo "ğŸ¯ å°è¯• Windows äº¤å‰ç¼–è¯‘..."
    - |
      if cargo build --release --target x86_64-pc-windows-gnu; then
        echo "âœ… Windows äº¤å‰ç¼–è¯‘æˆåŠŸï¼"
        WINDOWS_BUILD=true
      else
        echo "âŒ Windows äº¤å‰ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•æœ¬åœ°ç¼–è¯‘..."
        WINDOWS_BUILD=false
        cargo build --release || echo "âŒ æœ¬åœ°ç¼–è¯‘ä¹Ÿå¤±è´¥"
      fi
    
    # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
    - echo "ğŸ“‹ æ£€æŸ¥ç¼–è¯‘äº§ç‰©..."
    - ls -la target/ || echo "âŒ target ç›®å½•ä¸å­˜åœ¨"
    - find target/ -name "*.exe" 2>/dev/null | head -10 || echo "âŒ æœªæ‰¾åˆ° exe æ–‡ä»¶"
    - find target/ -name "*lottery*" 2>/dev/null | head -10 || echo "âŒ æœªæ‰¾åˆ°é¡¹ç›®ç›¸å…³æ–‡ä»¶"
    
    # åˆ›å»ºäº§ç‰©ç›®å½• 
    - echo "ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©..."
    - mkdir -p ../release-optimized/
    - |
      # å¤åˆ¶ Windows å¯æ‰§è¡Œæ–‡ä»¶
      if ls target/x86_64-pc-windows-gnu/release/*.exe 1> /dev/null 2>&1; then
        cp target/x86_64-pc-windows-gnu/release/*.exe ../release-optimized/
        echo "âœ… å¤åˆ¶ Windows exe æ–‡ä»¶æˆåŠŸ"
      else
        echo "âŒ æœªæ‰¾åˆ° Windows exe æ–‡ä»¶"
      fi
      
      # å¤åˆ¶æœ¬åœ°ç¼–è¯‘çš„æ–‡ä»¶
      if ls target/release/*lottery* 1> /dev/null 2>&1; then
        cp target/release/*lottery* ../release-optimized/
        echo "âœ… å¤åˆ¶æœ¬åœ°ç¼–è¯‘æ–‡ä»¶æˆåŠŸ"
      else
        echo "âŒ æœªæ‰¾åˆ°æœ¬åœ°ç¼–è¯‘æ–‡ä»¶"
      fi
      
      # æ˜¾ç¤ºæœ€ç»ˆäº§ç‰©
      echo "ğŸ“‹ æœ€ç»ˆäº§ç‰©åˆ—è¡¨ï¼š"
      ls -la ../release-optimized/ || echo "âŒ äº§ç‰©ç›®å½•ä¸ºç©º"
    
    - echo "ğŸ‰ ç¼–è¯‘æµç¨‹å®Œæˆï¼"
    
  artifacts:
    name: "windows-optimized-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-optimized/
    expire_in: 30 days
    when: always  # å³ä½¿éƒ¨åˆ†å¤±è´¥ä¹Ÿä¿å­˜äº§ç‰©
    
  only:
    - main
    - develop
    - merge_requests
    - tags
    
  tags:
    - linux
    
  # å…è®¸å¤±è´¥ï¼Œæ–¹ä¾¿è°ƒè¯•
  allow_failure: true 