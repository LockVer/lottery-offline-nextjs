# Docker äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
# ä»…éœ€è¦ Linux Runnerï¼Œä½¿ç”¨ Docker å®¹å™¨è¿›è¡Œ Windows äº¤å‰ç¼–è¯‘

stages:
  - build

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  DEBIAN_FRONTEND: noninteractive

# ç¼“å­˜é…ç½®
cache:
  key: "$CI_COMMIT_REF_NAME"
  paths:
    - node_modules/
    - .cargo/

# Docker äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
build-windows-docker:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    # ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº
    MIRROR_URL: "http://mirrors.aliyun.com"
    # Docker é…ç½®
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    # å®‰è£…åŸºç¡€å·¥å…·
    - apk add --no-cache curl wget bash
    
    # ç­‰å¾… Docker æœåŠ¡å¯åŠ¨
    - echo "â³ ç­‰å¾… Docker æœåŠ¡å¯åŠ¨..."
    - until docker info >/dev/null 2>&1; do echo "ç­‰å¾… Docker..."; sleep 2; done
    - echo "âœ… Docker æœåŠ¡å·²å°±ç»ª"
    - docker info
    
    # æ„å»ºè‡ªå®šä¹‰äº¤å‰ç¼–è¯‘é•œåƒ
    - |
      cat > Dockerfile.cross << 'EOF'
      FROM ubuntu:22.04
      
      # è®¾ç½®ç¯å¢ƒå˜é‡
      ENV DEBIAN_FRONTEND=noninteractive
      ENV RUSTUP_HOME=/usr/local/rustup
      ENV CARGO_HOME=/usr/local/cargo
      ENV PATH=/usr/local/cargo/bin:$PATH
      
      # é…ç½®é˜¿é‡Œäº‘é•œåƒæº
      RUN echo "deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
          echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
          echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list && \
          echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list
      
      # å®‰è£…ç³»ç»Ÿä¾èµ–
      RUN apt-get update && apt-get install -y \
          curl wget build-essential \
          pkg-config libssl-dev \
          libgtk-3-dev libayatana-appindicator3-dev \
          librsvg2-dev libwebkit2gtk-4.0-dev \
          mingw-w64 gcc-mingw-w64 \
          xz-utils ca-certificates && \
          rm -rf /var/lib/apt/lists/*
      
      # å®‰è£… Node.js 22.16.0
      RUN wget -qO /tmp/node.tar.xz https://mirrors.aliyun.com/nodejs-release/v22.16.0/node-v22.16.0-linux-x64.tar.xz && \
          tar -xJ -C /opt -f /tmp/node.tar.xz && \
          ln -sf /opt/node-v22.16.0-linux-x64/bin/* /usr/local/bin/ && \
          rm /tmp/node.tar.xz
      
      # å®‰è£… Rust
      RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable && \
          rustup target add x86_64-pc-windows-gnu
      
      # é…ç½® Cargo äº¤å‰ç¼–è¯‘
      RUN mkdir -p ~/.cargo && \
          echo '[target.x86_64-pc-windows-gnu]' > ~/.cargo/config.toml && \
          echo 'linker = "x86_64-w64-mingw32-gcc"' >> ~/.cargo/config.toml && \
          echo 'ar = "x86_64-w64-mingw32-ar"' >> ~/.cargo/config.toml
      
      # è®¾ç½®å·¥ä½œç›®å½•
      WORKDIR /workspace
      
      # è®¾ç½® npm é•œåƒæº
      RUN npm config set registry https://registry.npmmirror.com
      EOF
    
    # æ„å»ºäº¤å‰ç¼–è¯‘é•œåƒ
    - echo "ğŸ”¨ æ„å»ºäº¤å‰ç¼–è¯‘ Docker é•œåƒ..."
    - docker build -t tauri-cross-compile -f Dockerfile.cross .
    
  script:
    # åœ¨ Docker å®¹å™¨ä¸­æ‰§è¡Œäº¤å‰ç¼–è¯‘
    - echo "ğŸš€ å¼€å§‹ Docker äº¤å‰ç¼–è¯‘..."
    - |
      docker run --rm \
        -v $(pwd):/workspace \
        -w /workspace \
        tauri-cross-compile \
        bash -c "
          set -e
          echo 'ğŸ” ç¯å¢ƒæ£€æŸ¥:'
          node --version
          npm --version
          rustc --version
          cargo --version
          
          echo 'ğŸ“¦ å®‰è£…ä¾èµ–...'
          npm ci
          
          echo 'ğŸ”¨ æ„å»ºå‰ç«¯...'
          npm run build
          
          echo 'ğŸ¯ Windows äº¤å‰ç¼–è¯‘...'
          cd src-tauri
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè·³è¿‡ GTK ä¾èµ–æ£€æŸ¥
          export PKG_CONFIG_ALLOW_CROSS=1
          export PKG_CONFIG_PATH=
          export CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=x86_64-w64-mingw32-gcc
          
          # äº¤å‰ç¼–è¯‘
          cargo build --release --target x86_64-pc-windows-gnu --no-default-features
          
          echo 'ğŸ“‹ æ£€æŸ¥ç¼–è¯‘äº§ç‰©:'
          ls -la target/x86_64-pc-windows-gnu/release/
          find target/x86_64-pc-windows-gnu/release/ -name '*.exe' -type f
          
          echo 'ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶...'
          mkdir -p ../release-docker/
          cp target/x86_64-pc-windows-gnu/release/*.exe ../release-docker/ || echo 'æœªæ‰¾åˆ° exe æ–‡ä»¶'
          
          echo 'âœ… Docker äº¤å‰ç¼–è¯‘å®Œæˆ!'
        "
    
    # æ£€æŸ¥æœ€ç»ˆäº§ç‰©
    - echo "ğŸ“‹ æœ€ç»ˆäº§ç‰©æ£€æŸ¥:"
    - ls -la release-docker/ || echo "äº§ç‰©ç›®å½•ä¸å­˜åœ¨"
    
  artifacts:
    name: "windows-docker-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-docker/
    expire_in: 30 days
    when: always
    
  only:
    - main
    - develop
    - merge_requests
    - tags
    
  tags:
    - linux
    
  # å…è®¸å¤±è´¥ï¼Œæ–¹ä¾¿è°ƒè¯•
  allow_failure: true

# å¤‡é€‰æ–¹æ¡ˆï¼šç®€å• Linux æ„å»ºï¼ˆç”¨äºæµ‹è¯•ï¼‰
build-linux-fallback:
  stage: build
  image: ubuntu:22.04
  variables:
    MIRROR_URL: "http://mirrors.aliyun.com"
  before_script:
    # é…ç½®é•œåƒæº
    - echo "deb ${MIRROR_URL}/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list
    - echo "deb ${MIRROR_URL}/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list
    - echo "deb ${MIRROR_URL}/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list
    - echo "deb ${MIRROR_URL}/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list
    
    # å®‰è£…ä¾èµ–
    - apt-get update
    - apt-get install -y wget curl ca-certificates
    - apt-get install -y build-essential pkg-config libssl-dev
    - apt-get install -y libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libwebkit2gtk-4.0-dev
    
    # å®‰è£… Node.js
    - wget -qO /tmp/node.tar.xz https://mirrors.aliyun.com/nodejs-release/v22.16.0/node-v22.16.0-linux-x64.tar.xz
    - tar -xJ -C /opt -f /tmp/node.tar.xz && ln -sf /opt/node-v22.16.0-linux-x64/bin/* /usr/local/bin/
    
    # å®‰è£… Rust
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
    - source ~/.cargo/env
    
  script:
    # Linux æœ¬åœ°æ„å»º
    - echo "ğŸ”¨ Linux æœ¬åœ°æ„å»ºï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰..."
    - npm config set registry https://registry.npmmirror.com
    - npm ci
    - npm run build
    
    # æ„å»º Linux ç‰ˆæœ¬
    - cd src-tauri
    - source ~/.cargo/env
    - cargo build --release
    
    # æ•´ç†äº§ç‰©
    - mkdir -p ../release-linux/
    - cp target/release/* ../release-linux/ 2>/dev/null || echo "å¤åˆ¶äº§ç‰©"
    - echo "âœ… Linux æ„å»ºå®Œæˆ"
    
  artifacts:
    name: "linux-fallback-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-linux/
    expire_in: 7 days
    when: always
    
  only:
    - develop  # ä»…åœ¨å¼€å‘åˆ†æ”¯è¿è¡Œå¤‡é€‰æ–¹æ¡ˆ
    
  tags:
    - linux
    
  when: manual  # æ‰‹åŠ¨è§¦å‘ 

# GitLab CI/CD é…ç½® - Windows Docker åŸç”Ÿç¼–è¯‘

stages:
  - build

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

# ç¼“å­˜é…ç½®
cache:
  key: "$CI_COMMIT_REF_NAME"
  paths:
    - node_modules/
    - .cargo/

# Windows Docker åŸç”Ÿç¼–è¯‘
build-windows-native:
  stage: build
  image: mcr.microsoft.com/windows/servercore:ltsc2022
  variables:
    # PowerShell æ‰§è¡Œç­–ç•¥
    POWERSHELL_TELEMETRY_OPTOUT: 1
  before_script:
    # å®‰è£… Chocolatey åŒ…ç®¡ç†å™¨
    - |
      Set-ExecutionPolicy Bypass -Scope Process -Force
      [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
      iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
    
    # å®‰è£… Node.js
    - choco install nodejs --version=22.16.0 -y
    - refreshenv
    
    # å®‰è£… Rust
    - |
      Invoke-WebRequest -Uri "https://win.rustup.rs/" -OutFile "rustup-init.exe" -UseBasicParsing
      .\rustup-init.exe -y --default-toolchain stable
      Remove-Item .\rustup-init.exe
    
    # åˆ·æ–°ç¯å¢ƒå˜é‡
    - $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User")
    
    # éªŒè¯å®‰è£…
    - node --version
    - npm --version
    - cargo --version
    
  script:
    # å®‰è£…ä¾èµ–
    - echo "ğŸ“¦ å®‰è£… Node.js ä¾èµ–..."
    - npm ci
    
    # æ„å»ºå‰ç«¯
    - echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
    - npm run build
    
    # ç¼–è¯‘ Windows ç‰ˆæœ¬
    - echo "ğŸš€ å¼€å§‹ Windows åŸç”Ÿç¼–è¯‘..."
    - cd src-tauri
    - cargo build --release
    
    # æ£€æŸ¥ç¼–è¯‘äº§ç‰©
    - echo "ğŸ“‹ æ£€æŸ¥ç¼–è¯‘äº§ç‰©..."
    - Get-ChildItem -Path "target\release\" -Name "*.exe"
    
    # æ•´ç†äº§ç‰©
    - echo "ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©..."
    - New-Item -ItemType Directory -Path "..\release-windows-native" -Force
    - Copy-Item "target\release\*.exe" "..\release-windows-native\" -ErrorAction SilentlyContinue
    - Get-ChildItem "..\release-windows-native\"
    - echo "âœ… Windows åŸç”Ÿç¼–è¯‘å®Œæˆï¼"
    
  artifacts:
    name: "windows-native-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-windows-native/
    expire_in: 30 days
    when: always
    
  only:
    - main
    - develop
    - merge_requests
    - tags
    
  tags:
    - windows  # éœ€è¦ Windows Runner
    
  # å…è®¸å¤±è´¥ï¼Œæ–¹ä¾¿è°ƒè¯•
  allow_failure: true

# å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ Windows Server Core 2019
build-windows-2019:
  stage: build
  image: mcr.microsoft.com/windows/servercore:ltsc2019
  variables:
    POWERSHELL_TELEMETRY_OPTOUT: 1
  before_script:
    # ä½¿ç”¨æ›´å…¼å®¹çš„å®‰è£…æ–¹å¼
    - |
      # å®‰è£… Chocolatey
      Set-ExecutionPolicy Bypass -Scope Process -Force
      [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
      iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
    
    # å®‰è£…å·¥å…·
    - choco install nodejs --version=22.16.0 -y --force
    - choco install git -y
    - refreshenv
    
    # å®‰è£… Rust (ä½¿ç”¨å®˜æ–¹å®‰è£…å™¨)
    - |
      $rustupUrl = "https://win.rustup.rs/x86_64"
      Invoke-WebRequest -Uri $rustupUrl -OutFile "rustup-init.exe"
      Start-Process -FilePath ".\rustup-init.exe" -ArgumentList "-y" -Wait
      Remove-Item ".\rustup-init.exe"
    
    # æ·»åŠ  Cargo åˆ° PATH
    - $env:PATH += ";$env:USERPROFILE\.cargo\bin"
    
  script:
    # ç¯å¢ƒæ£€æŸ¥
    - echo "ğŸ” ç¯å¢ƒæ£€æŸ¥ï¼š"
    - node --version
    - npm --version
    - cargo --version
    
    # æ„å»ºé¡¹ç›®
    - echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
    - npm install
    
    - echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
    - npm run build
    
    - echo "ğŸš€ ç¼–è¯‘ Tauri åº”ç”¨..."
    - cd src-tauri
    - cargo build --release
    
    # æ•´ç†æ–‡ä»¶
    - echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
    - mkdir ..\release-2019 -ErrorAction SilentlyContinue
    - copy target\release\*.exe ..\release-2019\ -ErrorAction SilentlyContinue
    - dir ..\release-2019\
    
  artifacts:
    name: "windows-2019-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-2019/
    expire_in: 30 days
    when: always
    
  only:
    - develop  # ä»…åœ¨å¼€å‘åˆ†æ”¯æµ‹è¯•
    
  tags:
    - windows
    
  when: manual  # æ‰‹åŠ¨è§¦å‘

# Linux äº¤å‰ç¼–è¯‘å¤‡é€‰æ–¹æ¡ˆï¼ˆå¦‚æœæ²¡æœ‰ Windows Runnerï¼‰
build-linux-cross:
  stage: build
  image: ubuntu:22.04
  variables:
    MIRROR_URL: "http://mirrors.aliyun.com"
  before_script:
    # é…ç½®é•œåƒæº
    - echo "deb ${MIRROR_URL}/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list
    - echo "deb ${MIRROR_URL}/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list
    - echo "deb ${MIRROR_URL}/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list
    - echo "deb ${MIRROR_URL}/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list
    
    # å®‰è£…ä¾èµ– - åªå®‰è£…ç¼–è¯‘å¿…éœ€çš„ï¼Œè·³è¿‡ GTK
    - apt-get update
    - apt-get install -y wget curl ca-certificates build-essential pkg-config libssl-dev mingw-w64 xz-utils
    
    # å®‰è£… Node.js
    - wget -qO /tmp/node.tar.xz https://mirrors.aliyun.com/nodejs-release/v22.16.0/node-v22.16.0-linux-x64.tar.xz
    - tar -xJ -C /opt -f /tmp/node.tar.xz && ln -sf /opt/node-v22.16.0-linux-x64/bin/* /usr/local/bin/
    
    # å®‰è£… Rust
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
    - source ~/.cargo/env
    - rustup target add x86_64-pc-windows-gnu
    
    # é…ç½®äº¤å‰ç¼–è¯‘
    - mkdir -p ~/.cargo
    - echo '[target.x86_64-pc-windows-gnu]' > ~/.cargo/config.toml
    - echo 'linker = "x86_64-w64-mingw32-gcc"' >> ~/.cargo/config.toml
    
  script:
    - echo "âš ï¸  æ³¨æ„ï¼šè¿™æ˜¯å¤‡é€‰çš„ Linux äº¤å‰ç¼–è¯‘æ–¹æ¡ˆ"
    - npm config set registry https://registry.npmmirror.com
    - npm ci
    - npm run build
    
    # å°è¯•æ—  GUI ç¼–è¯‘
    - cd src-tauri
    - source ~/.cargo/env
    - echo "ğŸ¯ å°è¯•æ— é»˜è®¤ç‰¹æ€§ç¼–è¯‘..."
    - cargo build --release --target x86_64-pc-windows-gnu --no-default-features || echo "äº¤å‰ç¼–è¯‘å¤±è´¥"
    
    # æ•´ç†äº§ç‰©
    - mkdir -p ../release-cross-backup/
    - find target/ -name "*.exe" -exec cp {} ../release-cross-backup/ \; || echo "æœªæ‰¾åˆ° exe æ–‡ä»¶"
    
  artifacts:
    name: "linux-cross-backup-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-cross-backup/
    expire_in: 7 days
    when: always
    
  only:
    - develop
    
  tags:
    - linux
    
  when: manual  # ä»…ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ 