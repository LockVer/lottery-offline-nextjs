# Docker äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
# ä»…éœ€è¦ Linux Runnerï¼Œä½¿ç”¨ Docker å®¹å™¨è¿›è¡Œ Windows äº¤å‰ç¼–è¯‘

stages:
  - test
  - build
  - release

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

# ç¼“å­˜é…ç½®
cache:
  key: "$CI_COMMIT_REF_NAME"
  paths:
    - node_modules/
    - target/
    - .cargo/

# å¿«é€Ÿæµ‹è¯•
test-code:
  stage: test
  image: node:18
  script:
    - npm ci
    - npm run build
    - echo "âœ… å‰ç«¯æž„å»ºæµ‹è¯•é€šè¿‡"
  only:
    - main
    - develop
    - merge_requests

# Docker äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
build-windows-docker:
  stage: build
  image: ubuntu:20.04
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    # é…ç½®å›½å†…é•œåƒæºä»¥è§£å†³ç½‘ç»œé—®é¢˜
    - |
      cat > /etc/apt/sources.list << EOF
      deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse
      deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
      deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
      deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse
      EOF
    
    # å®‰è£…å¿…è¦å·¥å…·
    - apt-get update
    - apt-get install -y curl build-essential pkg-config libssl-dev
    
    # å®‰è£… Docker CLI (ä½¿ç”¨å›½å†…é•œåƒ)
    - curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg | apt-key add -
    - echo "deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu focal stable" > /etc/apt/sources.list.d/docker.list
    - apt-get update
    - apt-get install -y docker-ce-cli
    
    # å®‰è£… Node.js (ä½¿ç”¨å›½å†…é•œåƒ)
    - curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/nodesource/deb_18.x/setup_18.x | bash -
    - apt-get install -y nodejs
    
    # å®‰è£… Rust å’Œ Windows ç›®æ ‡ (ä½¿ç”¨å›½å†…é•œåƒ)
    - export RUSTUP_DIST_SERVER=https://mirrors.tuna.tsinghua.edu.cn/rustup
    - export RUSTUP_UPDATE_ROOT=https://mirrors.tuna.tsinghua.edu.cn/rustup/rustup
    - curl --proto '=https' --tlsv1.2 -sSf https://rsproxy.cn/rustup-init.sh | sh -s -- -y
    - source ~/.cargo/env
    - rustup target add x86_64-pc-windows-gnu
    
    # å®‰è£… mingw-w64 ç”¨äºŽ Windows äº¤å‰ç¼–è¯‘
    - apt-get install -y mingw-w64
    
    # é…ç½® Cargo äº¤å‰ç¼–è¯‘
    - mkdir -p ~/.cargo
    - |
      cat >> ~/.cargo/config.toml << EOF
      [target.x86_64-pc-windows-gnu]
      linker = "x86_64-w64-mingw32-gcc"
      ar = "x86_64-w64-mingw32-ar"
      EOF
  
  script:
    # æž„å»ºå‰ç«¯
    - echo "ðŸ”¨ æž„å»ºå‰ç«¯..."
    - npm ci
    - npm run build
    
    # äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
    - echo "ðŸš€ å¼€å§‹ Windows äº¤å‰ç¼–è¯‘..."
    - cd src-tauri
    
    # ä½¿ç”¨ cargo ç›´æŽ¥ç¼–è¯‘ Windows ç›®æ ‡
    - cargo build --release --target x86_64-pc-windows-gnu
    
    # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
    - echo "ðŸ“‹ ç¼–è¯‘äº§ç‰©ï¼š"
    - ls -la target/x86_64-pc-windows-gnu/release/
    - find target/x86_64-pc-windows-gnu/release/ -name "*.exe" | head -10
    
    # åˆ›å»ºç®€å•çš„æ‰“åŒ…
    - mkdir -p ../release-windows/
    - cp target/x86_64-pc-windows-gnu/release/*.exe ../release-windows/ || true
    - echo "âœ… Windows äº¤å‰ç¼–è¯‘å®Œæˆ"
    
  artifacts:
    name: "windows-cross-compiled-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-windows/
      - src-tauri/target/x86_64-pc-windows-gnu/release/*.exe
    expire_in: 30 days
    
  only:
    - main
    - develop
    - tags
    
  tags:
    - linux    # ä»…éœ€è¦ Linux Runner

# é«˜çº§ Docker æ–¹æ¡ˆ - ä½¿ç”¨ä¸“é—¨çš„äº¤å‰ç¼–è¯‘å®¹å™¨
build-windows-advanced:
  stage: build
  image: ghcr.io/cross-rs/cross:x86_64-pc-windows-gnu
  before_script:
    # é…ç½®é•œåƒæº
    - |
      if [ -f /etc/apt/sources.list ]; then
        cat > /etc/apt/sources.list << EOF
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse
        EOF
      fi
    - apt-get update || true
    # å®‰è£… Node.js
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
  script:
    # æž„å»ºå‰ç«¯
    - npm ci
    - npm run build
    
    # ä½¿ç”¨ cross è¿›è¡Œäº¤å‰ç¼–è¯‘
    - cd src-tauri
    - cargo install cross --git https://github.com/cross-rs/cross
    - cross build --release --target x86_64-pc-windows-gnu
    
    # æ•´ç†äº§ç‰©
    - mkdir -p ../release-advanced/
    - cp target/x86_64-pc-windows-gnu/release/*.exe ../release-advanced/ || true
    
  artifacts:
    name: "windows-advanced-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-advanced/
    expire_in: 30 days
    
  only:
    - tags    # ä»…åœ¨æ ‡ç­¾æ—¶ä½¿ç”¨é«˜çº§æ–¹æ¡ˆ
    
  tags:
    - linux
    
  when: manual  # æ‰‹åŠ¨è§¦å‘

# ç®€å•æ–¹æ¡ˆ - åŸºç¡€äº¤å‰ç¼–è¯‘
build-windows-simple:
  stage: build
  image: rust:1.70
  before_script:
    # é…ç½®é•œåƒæºè§£å†³ç½‘ç»œé—®é¢˜
    - |
      cat > /etc/apt/sources.list << EOF
      deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main
      deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main
      deb https://mirrors.tuna.tsinghua.edu.cn/debian-security/ bullseye-security main
      EOF
    
    # å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·
    - apt-get update
    - apt-get install -y mingw-w64 nodejs npm
    - rustup target add x86_64-pc-windows-gnu
    
    # é…ç½®äº¤å‰ç¼–è¯‘
    - mkdir -p ~/.cargo
    - echo '[target.x86_64-pc-windows-gnu]' >> ~/.cargo/config.toml
    - echo 'linker = "x86_64-w64-mingw32-gcc"' >> ~/.cargo/config.toml
    
  script:
    # æž„å»ºé¡¹ç›®
    - npm ci
    - npm run build
    
    # ä»…ç¼–è¯‘ Rust éƒ¨åˆ† (ä¸ä½¿ç”¨ Tauri bundle)
    - cd src-tauri
    - cargo build --release --target x86_64-pc-windows-gnu
    
    # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
    - mkdir -p ../release-simple/
    - cp target/x86_64-pc-windows-gnu/release/*.exe ../release-simple/
    - echo "âœ… ç®€å• Windows ç¼–è¯‘å®Œæˆ"
    
  artifacts:
    name: "windows-simple-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-simple/
    expire_in: 7 days
    
  only:
    - develop    # å¼€å‘åˆ†æ”¯ä½¿ç”¨ç®€å•æ–¹æ¡ˆæµ‹è¯•
    
  tags:
    - linux

# ç½‘ç»œä¼˜åŒ–ç‰ˆæœ¬ - ä½¿ç”¨é¢„è£…çŽ¯å¢ƒ
build-windows-optimized:
  stage: build
  image: ubuntu:22.04  # ä½¿ç”¨æ›´æ–°çš„ç‰ˆæœ¬
  before_script:
    # ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº
    - |
      cat > /etc/apt/sources.list << EOF
      deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
      deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
      deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse
      deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse
      EOF
    
    # å¿«é€Ÿå®‰è£…åŸºç¡€å·¥å…·
    - apt-get update
    - apt-get install -y wget curl build-essential pkg-config libssl-dev
    
    # å®‰è£… Node.js (ä½¿ç”¨äºŒè¿›åˆ¶åŒ…)
    - wget -qO- https://nodejs.org/dist/v18.19.0/node-v18.19.0-linux-x64.tar.xz | tar -xJ -C /opt
    - ln -sf /opt/node-v18.19.0-linux-x64/bin/* /usr/local/bin/
    
    # å®‰è£… Rust (ä½¿ç”¨å¿«é€Ÿå®‰è£…)
    - wget -qO- https://forge.rust-lang.org/infra/channel-layout.html
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
    - source ~/.cargo/env
    - rustup target add x86_64-pc-windows-gnu
    
    # å®‰è£… Windows äº¤å‰ç¼–è¯‘å·¥å…·
    - apt-get install -y mingw-w64
    
    # é…ç½® Cargo
    - mkdir -p ~/.cargo
    - |
      cat >> ~/.cargo/config.toml << EOF
      [target.x86_64-pc-windows-gnu]
      linker = "x86_64-w64-mingw32-gcc"
      ar = "x86_64-w64-mingw32-ar"
      EOF
  
  script:
    # æž„å»ºå‰ç«¯
    - echo "ðŸ”¨ æž„å»ºå‰ç«¯..."
    - npm ci
    - npm run build
    
    # äº¤å‰ç¼–è¯‘ Windows ç‰ˆæœ¬
    - echo "ðŸš€ å¼€å§‹ Windows äº¤å‰ç¼–è¯‘..."
    - cd src-tauri
    - source ~/.cargo/env
    - cargo build --release --target x86_64-pc-windows-gnu
    
    # æ•´ç†äº§ç‰©
    - mkdir -p ../release-optimized/
    - cp target/x86_64-pc-windows-gnu/release/*.exe ../release-optimized/ || true
    - echo "âœ… ä¼˜åŒ–ç‰ˆ Windows ç¼–è¯‘å®Œæˆ"
    
  artifacts:
    name: "windows-optimized-$CI_COMMIT_SHORT_SHA"
    paths:
      - release-optimized/
    expire_in: 30 days
    
  only:
    - main
    
  tags:
    - linux

# åˆ›å»ºå‘å¸ƒ
create-release:
  stage: release
  image: alpine:latest
  dependencies:
    - build-windows-docker
  before_script:
    - apk add --no-cache curl jq
  script:
    - mkdir -p final-release/
    - cp -r release-windows/* final-release/ || true
    - ls -la final-release/
    
    # åˆ›å»º Release (å¦‚æžœæ˜¯æ ‡ç­¾)
    - |
      if [ "$CI_COMMIT_TAG" ]; then
        echo "ðŸš€ åˆ›å»º Release: $CI_COMMIT_TAG"
        curl --fail --request POST \
          --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
          --header "Content-Type: application/json" \
          --data '{
            "name": "Windows äº¤å‰ç¼–è¯‘ç‰ˆæœ¬ '$CI_COMMIT_TAG'",
            "tag_name": "'$CI_COMMIT_TAG'",
            "description": "ðŸŽ‰ ä½¿ç”¨ Docker äº¤å‰ç¼–è¯‘çš„ Windows ç‰ˆæœ¬\n\n### ðŸ“¦ åŒ…å«æ–‡ä»¶\n- Windows å¯æ‰§è¡Œæ–‡ä»¶ (.exe)\n\n### âš ï¸ æ³¨æ„äº‹é¡¹\n- æ­¤ç‰ˆæœ¬ä½¿ç”¨äº¤å‰ç¼–è¯‘ç”Ÿæˆ\n- å¦‚é‡åˆ°å…¼å®¹æ€§é—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨ç‰©ç† Windows æœºå™¨ç¼–è¯‘çš„ç‰ˆæœ¬\n\n### ðŸ”§ ç¼–è¯‘ä¿¡æ¯\n- ç¼–è¯‘æ–¹å¼: Docker äº¤å‰ç¼–è¯‘\n- ç›®æ ‡å¹³å°: x86_64-pc-windows-gnu\n- æž„å»ºæ—¶é—´: '$CI_PIPELINE_CREATED_AT'\n\n---\n*ç”± GitLab CI/CD è‡ªåŠ¨æž„å»º*"
          }' \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
      fi
      
  artifacts:
    name: "windows-final-$CI_COMMIT_TAG"
    paths:
      - final-release/
    expire_in: 90 days
    
  only:
    - tags
    
  tags:
    - linux 