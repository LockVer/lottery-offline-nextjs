# GitLab CI/CD è·¨å¹³å°æ„å»ºé…ç½®
# æ”¯æŒ Windows, macOS, Linux è‡ªåŠ¨æ„å»º

# å®šä¹‰æ„å»ºé˜¶æ®µ
stages:
  - test          # æµ‹è¯•é˜¶æ®µ
  - build         # æ„å»ºé˜¶æ®µ
  - release       # å‘å¸ƒé˜¶æ®µ

# å…¨å±€å˜é‡
variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  NODE_VERSION: "18"

# ç¼“å­˜é…ç½® - åŠ é€Ÿæ„å»º
cache:
  paths:
    - node_modules/
    - .npm/
    - target/
    - ~/.cargo/

# æµ‹è¯•ä»»åŠ¡ - åœ¨ Linux ç¯å¢ƒä¸‹å¿«é€ŸéªŒè¯
test:
  stage: test
  image: node:18
  before_script:
    # å®‰è£… Rust
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source ~/.cargo/env
    # å®‰è£…ç³»ç»Ÿä¾èµ–
    - apt-get update
    - apt-get install -y libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf
  script:
    - npm ci
    - npm run build
    - npm run tauri info
  only:
    - merge_requests
    - develop
    - main

# Windows æ„å»º
build:windows:
  stage: build
  tags:
    - windows    # éœ€è¦ Windows Runner
  before_script:
    # å®‰è£… Node.js (å¦‚æœ Runner æ²¡æœ‰é¢„è£…)
    - choco install nodejs --version=18.17.0 -y
    # å®‰è£… Rust (å¦‚æœ Runner æ²¡æœ‰é¢„è£…)
    - |
      if (-not (Get-Command rustc -ErrorAction SilentlyContinue)) {
        Invoke-WebRequest -Uri "https://win.rustup.rs/" -OutFile "rustup-init.exe"
        .\rustup-init.exe -y
        $env:PATH += ";$env:USERPROFILE\.cargo\bin"
      }
  script:
    - npm ci
    - npm run build
    - npm run tauri build
  artifacts:
    name: "windows-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/msi/
      - src-tauri/target/release/bundle/nsis/
    expire_in: 7 days
  only:
    - tags
    - main
    - develop

# macOS æ„å»º (Intel)
build:macos-intel:
  stage: build
  tags:
    - macos      # éœ€è¦ macOS Runner
  before_script:
    # å®‰è£… Node.js
    - brew install node@18
    - export PATH="/opt/homebrew/opt/node@18/bin:$PATH"
    # å®‰è£… Rust ç›®æ ‡å¹³å°
    - rustup target add x86_64-apple-darwin
  script:
    - npm ci
    - npm run build
    - npm run tauri build --target x86_64-apple-darwin
  artifacts:
    name: "macos-intel-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/
      - src-tauri/target/x86_64-apple-darwin/release/bundle/macos/
    expire_in: 7 days
  only:
    - tags
    - main

# macOS æ„å»º (Apple Silicon)
build:macos-silicon:
  stage: build
  tags:
    - macos      # éœ€è¦ macOS Runner
  before_script:
    - brew install node@18
    - export PATH="/opt/homebrew/opt/node@18/bin:$PATH"
    - rustup target add aarch64-apple-darwin
  script:
    - npm ci
    - npm run build
    - npm run tauri build --target aarch64-apple-darwin
  artifacts:
    name: "macos-silicon-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/
      - src-tauri/target/aarch64-apple-darwin/release/bundle/macos/
    expire_in: 7 days
  only:
    - tags
    - main

# Linux æ„å»º
build:linux:
  stage: build
  image: ubuntu:20.04
  before_script:
    # å®‰è£…ç³»ç»Ÿä¾èµ–
    - apt-get update
    - apt-get install -y curl build-essential libssl-dev pkg-config
    - apt-get install -y libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf
    # å®‰è£… Node.js
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    # å®‰è£… Rust
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source ~/.cargo/env
  script:
    - npm ci
    - npm run build
    - npm run tauri build
  artifacts:
    name: "linux-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/deb/
      - src-tauri/target/release/bundle/appimage/
    expire_in: 7 days
  only:
    - tags
    - main
    - develop

# åˆ›å»ºå‘å¸ƒç‰ˆæœ¬ (ä»…é™æ ‡ç­¾)
release:
  stage: release
  image: alpine:latest
  dependencies:
    - build:windows
    - build:macos-intel
    - build:macos-silicon
    - build:linux
  before_script:
    - apk add --no-cache curl
  script:
    # åˆ›å»ºå‘å¸ƒæ–‡ä»¶å¤¹
    - mkdir -p release-files
    
    # æ”¶é›†æ‰€æœ‰æ„å»ºäº§ç‰©
    - find . -name "*.msi" -exec cp {} release-files/ \; || true
    - find . -name "*.exe" -exec cp {} release-files/ \; || true
    - find . -name "*.dmg" -exec cp {} release-files/ \; || true
    - find . -name "*.deb" -exec cp {} release-files/ \; || true
    - find . -name "*.AppImage" -exec cp {} release-files/ \; || true
    
    # æ˜¾ç¤ºæ”¶é›†åˆ°çš„æ–‡ä»¶
    - ls -la release-files/
    
    # ä½¿ç”¨ GitLab Release API åˆ›å»ºå‘å¸ƒ
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --header "Content-Type: application/json" \
        --data '{
          "name": "Release '$CI_COMMIT_TAG'",
          "tag_name": "'$CI_COMMIT_TAG'",
          "description": "ğŸ‰ è‡ªåŠ¨æ„å»ºå‘å¸ƒç‰ˆæœ¬\n\n### ğŸ“¦ æ”¯æŒå¹³å°\n- Windows x64 (.msi/.exe)\n- macOS Intel (.dmg)\n- macOS Apple Silicon (.dmg)\n- Linux x64 (.deb/.AppImage)\n\næ„å»ºç‰ˆæœ¬: '$CI_COMMIT_SHORT_SHA'"
        }' \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  artifacts:
    name: "release-$CI_COMMIT_TAG"
    paths:
      - release-files/
    expire_in: 30 days
  only:
    - tags

# æ‰‹åŠ¨è§¦å‘çš„å¿«é€Ÿæµ‹è¯•æ„å»º
test-build:
  stage: build
  image: ubuntu:20.04
  before_script:
    - apt-get update
    - apt-get install -y curl build-essential libssl-dev pkg-config
    - apt-get install -y libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source ~/.cargo/env
  script:
    - npm ci
    - npm run build
    - echo "âœ… æµ‹è¯•æ„å»ºæˆåŠŸï¼å¯ä»¥è¿›è¡Œæ­£å¼çš„è·¨å¹³å°æ„å»ºã€‚"
  artifacts:
    name: "test-build-$CI_COMMIT_SHORT_SHA"
    paths:
      - dist/
    expire_in: 1 day
  when: manual  # æ‰‹åŠ¨è§¦å‘
  except:
    - tags 